// kafka/Jenkinsfile

pipeline {
    agent any

    triggers {}  // üîí –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (webhook, polling –∏ —Ç.–¥.)

    parameters {
        string(name: 'TARGET_NAMESPACE', defaultValue: 'test', description: '–¶–µ–ª–µ–≤–æ–π namespace')
        booleanParam(name: 'DRY_RUN', defaultValue: false, description: '–¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ (helm install --dry-run)')
    }

    stages {
        stage('Validate Trigger') {
            steps {
                script {
                    def cause = currentBuild.rawBuild.getCauses()
                    def isManual = cause.any { it.class.simpleName == 'UserIdCause' } // —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ UI
                    def isUpstream = cause.any { it.class.simpleName == 'UpstreamCause' } // –≤—ã–∑–æ–≤ –∏–∑ –¥—Ä—É–≥–æ–≥–æ job

                    if (!isManual && !isUpstream) {
                        currentBuild.result = 'ABORTED'
                        error("‚ùå –≠—Ç–æ—Ç –ø–∞–π–ø–ª–∞–π–Ω –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –¢–û–õ–¨–ö–û –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ (mybank).")
                    }
                    echo "‚úÖ –ó–∞–ø—É—Å–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω: ${isManual ? '—Ä—É—á–Ω–æ–π' : '–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞'}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Deploy Kafka via Helm') {
            steps {
                script {
                    dir('deployment') {
                        def cmd = """
                        helm dependency update .
                        helm upgrade --mybank ./ \\
                            --namespace \${TARGET_NAMESPACE} --create-namespace \\
                            --set kafka.enabled=true \\
                            --set kafka-ui.enabled=true
                        """

                        if (params.DRY_RUN) {
                            cmd += " --dry-run --debug"
                        }

                        sh cmd
                    }
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Kafka —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –≤ namespace: ${params.TARGET_NAMESPACE}"
        }
        failure {
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–∏ Kafka"
        }
    }
}